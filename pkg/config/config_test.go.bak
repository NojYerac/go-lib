package config

import (
	"os"

	. "github.com/onsi/ginkgo"
	. "github.com/onsi/gomega"
	"github.com/spf13/pflag"
	"github.com/spf13/viper"
)

const (
	confKey = "conf_key"
	testKey = "test_key"
	hostKey = "hostname"
)

func setEnv(e map[string]string) {
	for k, v := range e {
		_ = os.Setenv(k, v)
	}
}

var _ = Describe("Config", func() {
	var c Config
	var err error
	BeforeEach(func() {
		flag := &pflag.Flag{
			Name:      confKey,
			Shorthand: "k",
			Usage:     "test config var",
		}
		c = New("TEST", []Var{{
			Name:    confKey,
			Default: 99,
			Flag:    flag,
		}, {
			Name:     testKey,
			Required: true,
		}, {
			Name:     hostKey,
			Required: true,
		}})
		SetArgs("-c", "configs")
	})
	JustBeforeEach(func() {
		err = c.Init()
	})
	Describe("Config files", func() {
		Context("with a single file", func() {
			It("returns the original value", func() {
				Expect(viper.GetString(testKey)).To(Equal("original"))
				Expect(viper.GetString(hostKey)).To(Equal("0.0.0.0"))
			})
		})
		Context("with multiple file", func() {
			BeforeEach(func() {
				SetArgs("-c", "./configs/multi-config/")
			})
			It("returns the overridden value", func() {
				Expect(viper.GetString(testKey)).To(Equal("override"))
				Expect(viper.GetString(hostKey)).To(Equal("0.0.0.0"))
			})
		})
	})
	Describe("Config Vars", func() {
		var v int
		JustBeforeEach(func() {
			v = viper.GetInt(confKey)
		})
		Context("when no value is set", func() {
			It("should return the default value", func() {
				Expect(err).NotTo(HaveOccurred())
				Expect(v).To(Equal(99))
			})
		})
		Context("when an environment variable is set", func() {
			BeforeEach(func() {
				setEnv(map[string]string{"TEST_CONF_KEY": "100"})
			})
			It("should return the value", func() {
				Expect(err).NotTo(HaveOccurred())
				Expect(v).To(Equal(100))
			})
			AfterEach(func() {
				setEnv(map[string]string{"TEST_CONF_KEY": ""})
			})
		})
		Context("when a flag is set", func() {
			BeforeEach(func() {
				SetArgs("-c", "./configs", "--conf_key=101")
			})
			It("should return the value", func() {
				Expect(err).NotTo(HaveOccurred())
				Expect(v).To(Equal(101))
			})
		})
	})
})
